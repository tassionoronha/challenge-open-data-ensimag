<html>
  <head>
    <meta charset="utf8"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment-with-locales.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="data.json"></script>
    <script type="text/javascript" src="dataMonth.json"></script>
    <script type="text/javascript" src="monthlyDatas2007.json"></script>
    <script type="text/javascript" src="dailyDatas2007.json"></script>
    <script src="./classes/Factory.js" type="module"></script>
    <script type="text/javascript" src="Functions.js"></script>
  </head>

  <body>
    <div class="page-header">
      <h1>Pollution à Grenoble</h1>
    </div>
    <div id="charts" class="col-md-10">
      <canvas id="multiradar"></canvas>
    </div>
    <div id="filters" class="col-md-2 panel panel-info">
      <div class="panel-heading">
        <select id="type">
          <option value="0">Année par stations</option>
          <option value="1">Station par années</option>
          <option value="2">Station par Mois</option>
          <option value="3">Mois par stations</option>
        </select>
      </div>
      <div class="panel-body">
        <div class="filter" id="yearPanel">
          <label for="year" class="col-sm-6">Année</label>
          <input class="col-sm-5" type="number" name="year" id="year" value="2007" min="2007" max="2017"/>
        </div>
        <div class="filter" id="monthPanel" style="display: none">
          <label for="month" class="col-sm-6">Mois</label>
          <input class="col-sm-5" type="number" name="month" id="month" value="1" min="1" max="12"/>
        </div>
        <div class="filter" id="maxPanel">
          <label for="max" class="col-sm-6">Valeur max</label>
          <input class="col-sm-5" type="number" name="max" id="max" value="0" min="0" max="150"/>
        </div>
        <select id="stations" style="display: none;"></select>
      </div>
      <div class="panel-heading choice">
        <span>Radar</span>
        <label class="switch">
          <input id="graph" type="checkbox"/>
          <span class="slider round"/>
        </label>
        <span>Ligne</span>
      </div>
      <button id="resetFilters" class="btn btn-warning">Réinitialiser les filtres</button>
    </div>
    <div class="alert alert-warning col-md-12" id="notifications"></div>
    <script nomodule>
      console.log("Pas de module")
    </script>
    <script type='module'>
      import Factory from './classes/Factory.js';

      var canvas = document.getElementById('multiradar').getContext('2d');

      var argsChart = {
        year:2007,
        month: 1,
        canvas:canvas,
        station: 0,
        type: 0,
        state: []
      };

      var chart = new Factory('radar', argsChart).chart.generateChart();

      showErrors(chart);
      getStations(chart);
      getMax(chart);

      $("#month").bind("change paste keyup", function() {
        clearChart(canvas, chart);
        chart.setMonth(this.value);
        showErrors(chart);
      });
      $("#year").bind("change paste keyup", function() {
        clearChart(canvas, chart);
        chart.setYear(this.value);
        showErrors(chart);
      });

      $("#max").bind("change paste keyup", function() {
        clearChart(canvas, chart);
        chart.setFilterMax(this.value);
        showErrors(chart);
      });

      $("#type").bind("change", function() {
        clearChart(canvas, chart);
        chart.setType(this.value);
        $("#yearPanel").hide();
        $("#stations").hide();
        $("#monthPanel").hide();
        if (this.value == 1) {
          $("#stations").show();
        } else if (this.value == 0) {
          $("#yearPanel").show();
        } else if (this.value == 2) {
          $("#stations").show();
          $("#yearPanel").show();
        } else {
          $("#yearPanel").show();
          $("#monthPanel").show();
        }
        chart.redraw();
        showErrors(chart);
        getMax(chart);
      });

      $("#stations").change(function() {
        clearChart(canvas, chart);
        chart.setStation($("#stations").find(":selected").val());
        showErrors(chart);
      });

      $("#graph").change(function() {
        clearChart(canvas, chart);
        argsChart = {
          canvas: canvas,
          year: $("#year").val(),
          month: $("#month").val(),
          station: $("#stations").find(":selected").val(),
          type: $("#type").find(":selected").val(),
          state: chart.state
        };
        if (this.checked){
          chart = new Factory('line', argsChart).chart.generateChart();

        }else{
          chart = new Factory('radar', argsChart).chart.generateChart();
        }
        getMax(chart);
      });
      $("#resetFilters").click(function() {
        clearChart(canvas, chart);
        chart.resetFilters();
        getMax(chart);
        $("#year").val(chart.year);
        $("#month").val(chart.month+1);
        $("#stations").val(chart.station);
      });

    </script>
  </body>
</html>
